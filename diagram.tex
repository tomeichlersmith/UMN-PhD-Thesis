\documentclass[tikz]{standalone}
\input{preamble}

\tikzmath{%
  \ecalbarlen=1.5;
  \ecalbarwidth=0.3;
}

\begin{document}
\begin{tikzpicture}
  %\draw[step=1cm,gray,very thin] (-6,-2) grid (12,2);

  \foreach \layerX/\layerY in {
    0.0/0.15,
    2.0/0.30,
    4.0/0.45,
    6.0/0.60,
    8.0/0.75,
    10.0/0.90
  }{
    \draw[HPSTracker, very thick]
      (\layerX-\sensorhalfsep,-\layerY-\sensorlen)
      -- (\layerX-\sensorhalfsep,-\layerY)
      (\layerX+\sensorhalfsep,-\layerY-\sensorlen)
      -- (\layerX+\sensorhalfsep,-\layerY)
      (\layerX-\sensorhalfsep,\layerY+\sensorlen)
      -- (\layerX-\sensorhalfsep,\layerY)
      (\layerX+\sensorhalfsep,\layerY+\sensorlen)
      -- (\layerX+\sensorhalfsep,\layerY);
  }
  \draw[HPSTracker] (9.0,0.75+\sensorlen) node[above,font=\LARGE] {SVT};

  \foreach \barY in {
    0.9,
    1.2,
    1.5,
    1.8,
    2.1
  }{
    \draw[draw=HPSEcal,fill=HPSEcal!20!white]
      (12.0,\barY) rectangle (12+\ecalbarlen,\barY+\ecalbarwidth)
      (12.0,-\barY) rectangle (12+\ecalbarlen,-\barY-\ecalbarwidth)
    ;
  }
  \draw[HPSEcal] (12+\ecalbarlen/2,2.1+\ecalbarwidth) node[above,font=\LARGE] {ECal};

  \draw[gray,dashed] (\targetx,0) -- (12+\ecalbarlen+0.5,0);
  
  \fill[HPSTarget] (\targetx-\targethalfthick,+1) rectangle (\targetx+\targethalfthick,-1);
  \draw[HPSTarget] (\targetx,-1) node[below left,font=\LARGE] {Target};

  \node (decay) at (\targetx+1.0,0.05) [circle,fill,inner sep=1.5pt] {};
  \node (production) at (\targetx,0.0) [circle,fill,inner sep=1.5pt] {};

  \draw[black,very thick,->]
    (\targetx-1.5,0.0) node[anchor=south east,font=\Large] {\(e^-\)} -- (\targetx-0.2,0.0);
  \draw[black,very thick,->]
    (decay) -- (11.8,1.6) node[anchor=south east,font=\Large] {\(e^-\)};
  \draw[black,very thick,->]
    (decay) -- (11.8,-2.2) node[anchor=north east,font=\Large] {\(e^+\)};
  \draw[black,very thick,->]
    (production) -- (-1.0,-0.5-\sensorlen) node[anchor=east,font=\Large] {\(e^-\)};

  \draw[blue,thick,->] (production) -- (decay) node[midway,above,font=\Large] {\(V_D\)};

  \begin{feynman}[inline]
    \vertex (beam) at (\targetx-3.0,4.0) {\(e^-\)};
    \vertex [right= of beam] (d);
    \vertex [below=of d, blob,label={below:$Z$}] (e) {};
    \vertex [right= of d] (b);
    \vertex [above right= of b] (g) {$e^{-}$};
    \vertex [below right= of b] (aprime_decay);
    \vertex [below right= of aprime_decay] (rhod_decay);
    \vertex [above right= of aprime_decay] (dm) {$\pi_D$};
    \diagram*[large] {
    (beam) -- [fermion] (d),
    (d) -- [boson] (e),
    (d) -- [fermion] (b),
    (b) -- [fermion] (g),
    (b) -- [boson, edge label={$A'$}] (aprime_decay) -- [double, edge label={$V_D$}] (rhod_decay),
    (aprime_decay) -- [scalar] (dm),
    };
  \end{feynman}
  
  \draw[black] (b) circle (2.5);
  \draw[black] (\targetx-2.7,2.15) -- (production) (\targetx+0.8,3.0) -- (production);


%  \draw[gray,dotted,very thick,->]
%    (\targetx-0.5,1) node[anchor=south east] {\Large Production} -- (production);
%  \draw[gray,dotted,->]
%    (\targetx+1.5,-1.5) node[anchor=north west] {\Large Decay} -- (decay);

%  \node at (\targetx,+2) {L1L1};
%  \node at (\targetx+1,0.1) [circle,fill,inner sep=1.5pt] {};
%  \draw[black,->] (\targetx+1,0.1) -- (2.5,2) node[anchor=south west] {\(e^-\)};
%  \draw[black,->] (\targetx+1,0.1) -- (2.5,-2.2) node[anchor=north west] {\(e^+\)};
\end{tikzpicture}
\end{document}
